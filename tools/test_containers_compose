#!/bin/bash

set -euo pipefail

for i in webui worker; do
  (
    cd container/$i/ &&
    if [[ $i = "webui" ]]; then
      echo "Building previously"
      time sudo docker build . -t openqa_webui
    fi
    date &&
    time sudo docker-compose build -q --parallel &&
    date &&
    time sudo docker-compose up -d &&
   (docker-compose ps --services --filter status=stopped | grep "^[[:space:]]*$") || (docker-compose logs; sudo docker-compose ps; exit 1)
  ) || exit 1;
done
